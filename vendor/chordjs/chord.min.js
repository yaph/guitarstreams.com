function Chord(c,b,a,d){this.init(c,b,a,d)}Chord.defaultSize=3;Chord.renderOnLoad=true;Chord.MUTED=-1;Chord.regex=/^([0-9xX]{4,6}|(?:x|X|\d\d?)(?:[-\. ](?:x|X|\d\d?)){3,5})(?:\s*\[([T\d]+)\])?(?:\s*(\d+))?/g;Chord.searchRegex=/\b([ABCDEFG](?:[a-z0-9#])*)\s*\(?([0-9xX]{4,6}|(?:x|X|\d\d?)(?:[-\. ](?:x|X|\d\d?)){3,5})\)?(?:\s*\[([T\d]+)\])?(?:\s*(\d+))?/g;Chord.prototype={init:function(c,a,b){this.parse(a,b);this.name=c;this.rawPositions=a;this.rawFingers=b||""},parse:function(l,d){this.positions=[];var h=[];if(l.match(/^[0-9xX]{1,6}$/)){for(var e=0;e<l.length;e++){h.push(l.charAt(e))}}else{h=l.split(/[^\dxX]/)}this.stringCount=h.length;if(this.stringCount==4){this.fretCount=4}else{this.fretCount=5}var g=0;var a=1000;for(var e in h){var f=h[e];if(f.toLowerCase()=="x"){this.positions.push(Chord.MUTED)}else{var k=parseInt(f);if(k>0&&k<a){a=k}g=Math.max(g,k);this.positions.push(k)}}if(g<=this.fretCount){this.startFret=1}else{this.startFret=a}this.fingerings=[];if(!d){return}var b=0;for(var e=0;e<d.length;e++){for(;b<this.positions.length;b++){if(this.positions[b]<=0){this.fingerings.push(null)}else{this.fingerings.push(d[e]);b++;break}}}},drawMutedAndOpenStrings:function(d){var c=this.renderer;for(var b in this.positions){var f=this.positions[b];var a=d.boxStartX+b*d.cellWidth;var e=d.nameFontSize+d.nameFontPaddingBottom+d.dotRadius-2;if(this.startFret>1){e+=d.nutSize}if(f==Chord.MUTED){this.drawCross(d,a,e,d.muteStringRadius,d.muteStringLineWidth)}else{if(f==0){c.circle(a,e,d.openStringRadius,false,d.openStringLineWidth)}}}},drawPositions:function(e){var c=this.renderer;for(var b in this.positions){var g=this.positions[b];if(g>0){var d=g-this.startFret+1;var a=e.boxStartX+b*e.cellWidth;if(d<=5){var f=e.boxStartY+d*e.cellHeight-(e.cellHeight/2);c.circle(a,f,e.dotRadius,true)}}}},toString:function(){return"Chord"},drawFretGrid:function(e){var d=this.renderer;var c=(this.stringCount-1)*e.cellWidth;for(var b=0;b<=this.stringCount-1;b++){var a=e.boxStartX+b*e.cellWidth;d.line(a,e.boxStartY,a,e.boxStartY+this.fretCount*e.cellHeight,e.lineWidth,"square")}for(var b=0;b<=this.fretCount;b++){var f=e.boxStartY+b*e.cellHeight;d.line(e.boxStartX,f,e.boxStartX+c,f,e.lineWidth,"square")}},drawNut:function(b){var a=this.renderer;if(this.startFret==1){a.rect(b.boxStartX,b.boxStartY-b.nutSize,b.boxWidth,b.nutSize,b.lineWidth)}else{a.text(b.boxStartX-b.dotRadius,b.boxStartY+b.cellHeight/2,this.startFret+"",b.font,b.fretFontSize,"middle","right")}},drawName:function(b){var a=this.renderer;a.text(b.width/2,b.nameFontSize+b.lineWidth*3,this.name,b.font,b.nameFontSize,"bottom","center")},sizes:{cellWidth:[4,6,8,10,12,14,16,18,20,22],nutSize:[2,3,4,5,6,7,8,9,10,11],lineWidth:[1,1,1,1,1,1,2,2,2,2],barWidth:[2.5,3,5,7,7,9,10,10,12,12],dotRadius:[2,2.8,3.7,4.5,5.3,6.5,7,8,9,10],openStringRadius:[1.5,2,2.5,3,3.5,4,4.5,5,5.5,6.5],openStringLineWidth:[1,1.2,1.2,1.4,1.4,1.4,1.6,2,2,2],muteStringRadius:[2,2.5,3,3.5,4,4.5,5,5.5,6,6.5],muteStringLineWidth:[1.05,1.1,1.1,1.2,1.5,1.5,1.5,2,2.4,2.5],nameFontSize:[10,14,18,22,26,32,36,40,44,48],nameFontPaddingBottom:[4,4,5,4,4,4,5,5,5,5],fingerFontSize:[7,8,9,11,13,14,15,18,20,22],fretFontSize:[6,8,10,12,14,14,16,17,18,19]},calculateDimensions:function(c){var b={};c--;for(var a in this.sizes){b[a]=this.sizes[a][c]}b.scale=c;b.positions=this.rawPositions;b.fingers=this.rawFingers;b.name=this.name;b.cellHeight=b.cellWidth;b.dotWidth=2*b.dotRadius;b.font="Arial";b.boxWidth=(this.stringCount-1)*b.cellWidth;b.boxHeight=(this.fretCount)*b.cellHeight;b.width=b.boxWidth+4*b.cellWidth;b.height=b.nameFontSize+b.nameFontPaddingBottom+b.dotWidth+b.nutSize+b.boxHeight+b.fingerFontSize+4;b.boxStartX=Math.round(((b.width-b.boxWidth)/2));b.boxStartY=Math.round(b.nameFontSize+b.nameFontPaddingBottom+b.nutSize+b.dotWidth);return b},draw:function(b){var a=this.calculateDimensions(b);this.renderer.init(a);this.drawFretGrid(a);this.drawNut(a);this.drawName(a);this.drawMutedAndOpenStrings(a);this.drawPositions(a);this.drawFingerings(a);this.drawBars(a)},getDiagram:function(b,a){this.renderer=Chord.renderers.canvas;this.draw(b);return this.renderer.diagram()},drawBars:function(c){var a=this.renderer;if(this.fingerings.length>0){var k={};for(var f=0;f<this.positions.length;f++){var l=this.positions[f];if(l>0){if(k[l]&&k[l].finger==this.fingerings[f]){k[l].length=f-k[l].index}else{k[l]={finger:this.fingerings[f],length:0,index:f}}}}for(var l in k){if(k[l].length>0){var g=c.boxStartX+k[l].index*c.cellWidth;var b=g+k[l].length*c.cellWidth;var e=l-this.startFret+1;var h=c.boxStartY+e*c.cellHeight-(c.cellHeight/2);console.log("y: "+h+", barWidth: "+c.barWidth);a.line(g,h,b,h,c.barWidth,"square")}}}else{var d=this.positions[this.positions.length-1];if(d<=0){return}if(this.positions.join("")=="-1-10232"){return}var j=-1;for(var f=0;f<this.positions.length-2;f++){var l=this.positions[f];if(l>0&&l<d){return}else{if(l==d&&j==-1){j=f}else{if(j!=-1&&l<d){return}}}}if(j>=0){var g=c.boxStartX+j*c.cellWidth;var b=(this.positions.length-1)*c.cellWidth;var e=d-this.startFret+1;var h=c.boxStartY+e*c.cellHeight-(c.cellHeight/2);a.line(g,h,b,h,c.dotRadius,"square")}}},drawCross:function(c,m,l,j,h){var a=this.renderer;var d=Math.PI/4;for(var f=0;f<2;f++){var k=d+f*Math.PI/2;var b=k+Math.PI;var g=m+j*Math.cos(k);var e=l+j*Math.sin(k);var o=m+j*Math.cos(b);var n=l+j*Math.sin(b);a.line(g,e,o,n,h,"round")}},drawFingerings:function(f){var c=this.renderer;var e=f.fingerFontSize;for(var b in this.fingerings){var d=this.fingerings[b];var a=f.boxStartX+b*f.cellWidth;var g=f.boxStartY+f.boxHeight+e+f.lineWidth+1;if(d){c.text(a,g,d,f.font,e,"bottom","center")}}}};Chord.renderers={};Chord.renderers.canvas={init:function(b){this.canvas=document.createElement("canvas");var a=this.ctx=this.canvas.getContext("2d");this.canvas.width=b.width;this.canvas.height=b.height;if(b.lineWidth%2==1){a.translate(0.5,0.5)}a.fillStyle="white";a.fillRect(-1,-1,this.canvas.width+2,this.canvas.height+2);a.fillStyle="black";a.lineJoin="miter";a.lineWidth=b.lineWidth;a.lineCap="square";a.strokeStyle="black"},line:function(b,g,a,e,f,d){var h=this.ctx;h.save();if(f){h.lineWidth=f}h.lineCap=d||"square";h.beginPath();h.moveTo(b,g);h.lineTo(a,e);h.stroke();console.log("x1 "+b+", x2 "+a+" y1 "+g+" y2 "+e+" width: "+f);h.restore()},text:function(a,g,e,b,c,d,f){this.ctx.font=c+"px "+b;this.ctx.textBaseline=d;this.ctx.textAlign=f;this.ctx.fillText(e,a,g)},rect:function(c,e,d,b,a){this.ctx.fillRect(c-a/2,e-a/2,d+a,b+a)},circle:function(d,g,b,e,a){var f=this.ctx;f.beginPath();f.arc(d,g,b,2*Math.PI,false);if(e){f.fill()}else{f.lineWidth=a;f.stroke()}},diagram:function(){var a=document.createElement("img");a.src=this.canvas.toDataURL();return a}};Chord.autoRender=function(){if(!Chord.renderOnLoad){return}Chord.render(document.getElementsByTagName("span"))};if(document.addEventListener){document.addEventListener("DOMContentLoaded",Chord.autoRender,true)}else{if(window.attachEvent){window.attachEvent("onload",Chord.autoRender)}}Chord.render=function(f){for(var c=0;c<f.length;c++){var d=f[c];var e=d.getAttribute("data-chord");var a=d.firstChild.nodeValue;if(e&&e.match(Chord.regex)){var b=Chord.defaultSize;if(RegExp.$3){b=parseInt(RegExp.$3)}d.replaceChild(new Chord(a,RegExp.$1,RegExp.$2).getDiagram(b),d.firstChild)}}};