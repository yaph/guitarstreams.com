'use strict';var selected_instrument=settings.instrument.toLowerCase();var selected_notes=chromatic_scale.slice();var selected_fret_count=15;var selected_root='C';var selected_mode='ionian';var selected_triad=null;var highlight_color='#eeeeee';var mode_options=[{id:null,name:'Mode'},{id:'ionian',name:'Ionian (Major Scale)'},{id:'dorian',name:'Dorian'},{id:'phrygian',name:'Phrygian'},{id:'lydian',name:'Lydian'},{id:'mixolydian',name:'Mixolydian'},{id:'aeolion',name:'Aeolion (Minor Scale)'},{id:'locrian',name:'Locrian'},{id:'harmonic_minor',name:'Harmonic Minor'},{id:'melodic_minor',name:'Melodic Minor'},{id:'phrygian_dominant',name:'Phrygian Dominant'},{id:'major_pentatonic',name:'Major Pentatonic'},{id:'minor_pentatonic',name:'Minor Pentatonic'},{id:'blues',name:'Blues Scale'}];defaultSettings();showFretboard();window.addEventListener('setInstrument',function(e){selected_instrument=e.target.name;showFretboard()},false);d3.select('#notes').on('change',function(event){selected_notes=event.target.value.split(',').map(function(s){return noteDisplay(s)});showFretboard()});d3.select('#fret-count').on('change',function(event){selected_fret_count=d3.max([3,~~event.target.value]);showFretboard()});scaleOptions('#scale-root',chromatic_scale.slice(),function(d){return d||'Root'});d3.select('#scale-mode').on('change',function(event){return setScale(event)}).selectAll('option').data(mode_options).enter().append('option').attr('value',function(d){return d.id}).text(function(d){return d.name});function triadButton(triad){return'<h3 class="mt0">'+triad.name+'</h3><div>'+triad.notes.join('\u2012')+'</div>'}function defaultSettings(){d3.select('input[value="'+selected_instrument+'"]').attr('checked',true);d3.select('#notes').attr('value',selected_notes.join(', '));d3.select('#fret-count').attr('value',selected_fret_count)}function highlightTriadButton(event){var btn=event.target;var cls=btn.getAttribute('class');if(!cls||!cls.includes('triad-select')){btn=btn.parentElement}d3.select(btn).style('background-color',highlight_color)}function highlightNotes(notes){for(var idx in notes){var note=notes[idx];d3.selectAll('.notes circle[title="'+note+'"]').style('fill',traste.noteColor(note))}}function noteDisplay(note){var s=note.trim();return s.charAt(0).toUpperCase()+s.slice(1)}function options(list){list.unshift('');return list}function optionSelected(sid,value){d3.select('#'+sid+' option').attr('selected',null);d3.select('#'+sid+' option[value="'+value+'"]').attr('selected','selected')}function scaleOptions(selector,list,cb_text){d3.select(selector).on('change',setScale).selectAll('option').data(options(list)).enter().append('option').attr('value',function(d){return d}).text(cb_text)}function setTriad(event,triad){d3.selectAll('.triad-select').style('background-color','#fff');d3.selectAll('.notes circle').style('fill','#ffffff');if(selected_triad===triad){selected_triad=null;return}selected_triad=triad;highlightTriadButton(event);highlightNotes(selected_triad.notes)}function setScale(event){var target=event.target;if(!target.value)return;selected_triad=null;d3.selectAll('.triad-select').style('background-color','#fff');if('scale-root'==target.id){selected_root=target.value}else if('scale-mode'==target.id){selected_mode=target.value}optionSelected('scale-root',selected_root);optionSelected('scale-mode',selected_mode);var selected_scale=scale(selected_root,selected_mode);if(selected_scale.notes.length===8){setTriads(selected_scale)}selected_notes=selected_scale.notes.slice(0,-1);document.getElementById('notes').value=selected_notes.join(', ');showFretboard()}function setTriads(scale){d3.select('#triads').classed('dn',false).select('.title').text('Triads in the '+scale.root+' '+scale.mode.replace('_',' ')+' scale');var selection=d3.select('#triad-buttons').selectAll('a').data(scale.chord_family);selection.exit().remove();selection.enter().append('a').attr('class','triad-select b--moon-gray ba br2 bw2 dim ma1 pa2 pointer tc w-20').on('click',function(event,d){return setTriad(event,d)}).html(triadButton);selection.html(triadButton)}function showFretboard(){var instrument=traste.instruments[selected_instrument];instrument.fret_count=selected_fret_count;traste.drawFretboard('#fretboard',instrument,selected_notes);if(selected_triad){highlightNotes(selected_triad.notes)}else{highlightNotes(selected_notes)}}